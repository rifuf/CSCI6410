---
title: "Practical 1"
author: "Rifat Fariha B00937648"
date: "2024-05-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(readr)          # Data Input
library(tidymodels)     # Data Manipulation
library(lubridate)      # Data Manupulation
library(dplyr)          # Data Manipulation
library(reshape2)       # Data Manipulation
library(caTools)        # Data Manipulation
library(corrplot)       # Data Visualisation
library(ggplot2)        # Data Visualization
library(viridis)        # Data Visualization
library(ggthemes)       # Data Visualization
library(pROC)           # Metrics
library(caret)          # Machine Learning
library(xgboost)        # xgboost model
```

# Introduction

The Brazilian public health system, known as SUS for Unified Health System in its acronym in Portuguese, is one of the largest health system in the world, representing government investment of more than 9% of GDP. However, its operation is not homogeneous and there are distinct perceptions of quality from citizens in different regions of the country. Non-attendance of medical appointments contributes a significant additional burden on limited medical resources. This analysis will try and investigate possible factors behind non-attendance using an administrative database of appointment data from Vitoria, Espírito Santo, Brazil.

# Understanding the Data

## 1. Use the data dictionary describe each of the variables/features in the CSV in your report.

PatientID: Unique identifier for each patient 
AppointmentID: Unique identifier to each appointment 
Gender: Patient Gender (limited to Male or Female)
ScheduledDate: date on which the appointment was scheduled
AppointmentDate: date of the actual appointment
Age: Patient age
Neighbourhood: District of Vitória in which the appointment 
SocialWelfare: Patient is a recipient of Bolsa Família welfare payments
Hypertension: Patient previously diagnoised with hypertensio (Boolean)
Diabetes: Patient previously diagnosed with diabetes (Boolean)
AlcoholUseDisorder: Patient previously diagnosed with alcohol use disorder (Boolean)
Disability: Patient previously diagnosed with a disability (severity rated 0-4)
SMSReceived: At least 1 reminder text sent before appointment (Boolean)
NoShow: Patient did not attend scheduled appointment (Boolean: Yes/No)

## 2. Can you think of 3 hypotheses for why someone may be more likely to miss a medical appointment?

*Hypothesis 1:* Patients diagnosed with alcohol use disorder are more likely to miss their medical appointments compared to patients without such conditions.

*Hypothesis 2:* The severity of a patient's disability affects their likelihood of missing their medical appointments.

*Hypothesis 3:* Patients who receive reminder texts (SMS) are less likely to miss their medical appointments compared to those who do not receive such reminders.

## 3. Can you provide 3 examples of important contextual information that is missing in this data dictionary and dataset that could impact your analyses e.g., what type of medical appointment does each 'AppointmentID' refer to?

Three examples of contextual information in regards to the data dictionary and dataset are:

*1. Time of Day:* The dataset does not provide any information regarding the time of day for each appointment. The timing could heavily influence attendance of patient. For example, patients may be prone to missing appointments in the morning rather than in the afternoon. 

*2. Hospital or Clinic Location:* There are also no information regarding the location of the hospital or clinic where the appointment is. Factors regarding the location such as accessibility, distance, and quality of the facility could impact attendance.

*3. Type of Appointment:* The dataset also does not have any information about the type of appointment, like general check-up, vaccination, special consultation, etc. Different appointment types could lead to varying attendance patterns. 

# Data Parsing and Cleaning

## 4. Modify the following to make it reproducible i.e., downloads the data file directly from version control.

```{r}
raw.data <- read_csv('2016_05v2_VitoriaAppointmentData.csv', col_types='fffTTifllllflf')
```

Now we need to check data is valid: because we specified col_types and the data parsed without error most of our data seems to at least be formatted as we expect i.e., ages are integers

```{r}
raw.data %>% filter(Age > 110)
```

We can see there are 2 patient’s older than 110 which seems suspicious but we can’t actually say if this is impossible.

## 5. Are there any individuals with impossible ages? If so we can drop this row using filter i.e., data <- data %>% filter(CRITERIA)

```{r}
library(dplyr)

filtered_data <- raw.data %>%
  filter(Age > 110)
```

# Exploratory Data Analysis

First, we should get an idea if the data meets our expectations, there are newborns in the data (Age==0) and we wouldn’t expect any of these to be diagnosed with Diabetes, Alcohol Use Disorder, and Hypertension (although in theory it could be possible). We can easily check this:

```{r}
raw.data %>% filter(Age == 0) %>% select(Hypertension, Diabetes, AlcoholUseDisorder) %>% unique()
```

We can also explore things like how many different neighborhoods are there and how many appoints are from each?

```{r}
count(raw.data, Neighbourhood, sort = TRUE)
```

## 6. What is the maximum number of appointments from the same patient?

Let’s explore the correlation between variables:

```{r}
# let's define a plotting function
corplot = function(df){
  
  cor_matrix_raw <- round(cor(df),2)
  cor_matrix <- melt(cor_matrix_raw)
  
  
  #Get triangle of the correlation matrix
  #Lower Triangle
  get_lower_tri<-function(cor_matrix_raw){
    cor_matrix_raw[upper.tri(cor_matrix_raw)] <- NA
    return(cor_matrix_raw)
  }
  
  # Upper Triangle
  get_upper_tri <- function(cor_matrix_raw){
    cor_matrix_raw[lower.tri(cor_matrix_raw)]<- NA
    return(cor_matrix_raw)
  }
  
  upper_tri <- get_upper_tri(cor_matrix_raw)
  
  # Melt the correlation matrix
  cor_matrix <- melt(upper_tri, na.rm = TRUE)
  
  # Heatmap Plot
  cor_graph <- ggplot(data = cor_matrix, aes(Var2, Var1, fill = value))+
    geom_tile(color = "white")+
    scale_fill_gradient2(low = "darkorchid", high = "orangered", mid = "grey50", 
                         midpoint = 0, limit = c(-1,1), space = "Lab", 
                         name="Pearson\nCorrelation") +
    theme_minimal()+ 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, 
                                     size = 8, hjust = 1))+
    coord_fixed()+ geom_text(aes(Var2, Var1, label = value), color = "black", size = 2) +
    theme(
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      panel.grid.major = element_blank(),
      panel.border = element_blank(),
      panel.background = element_blank(),
      axis.ticks = element_blank())+
      ggtitle("Correlation Heatmap")+
      theme(plot.title = element_text(hjust = 0.5))
  
  cor_graph
}

numeric.data = mutate_all(raw.data, function(x) as.numeric(x))

# Plot Correlation Heatmap
corplot(numeric.data)
```


